# =============================================================================
# Luxia Research Project - Azure App Service Deployment
# =============================================================================
# This workflow builds a unified Docker container containing all backend services
# and deploys it to Azure App Service.
#
# Architecture:
#   - Checks out multiple repos (socket-hub, dispatcher, worker, shared)
#   - Builds single container with all services
#   - Pushes to GitHub Container Registry (ghcr.io)
#   - Deploys to Azure App Service (luxia-backend)
#
# Triggers:
#   - Push to main branch of infra repo (azure/** or workflow changes)
#   - repository_dispatch from service repos (socket-hub, dispatcher, worker)
#   - Manual workflow_dispatch
# =============================================================================

name: Deploy to Azure App Service

on:
    push:
        branches:
            - main
        paths:
            - "azure/**"
            - ".github/workflows/deploy-azure.yml"

    # Triggered by service repos via repository_dispatch
    repository_dispatch:
        types: [service-updated]

    # Allow manual trigger for debugging
    workflow_dispatch:

# Prevent overlapping deployments
concurrency:
    group: luxia-azure-deploy
    cancel-in-progress: true

env:
    # Container registry settings
    REGISTRY: ghcr.io
    IMAGE_NAME: luxia-ai/luxia-dev-stack
    # Azure settings
    AZURE_WEBAPP_NAME: luxia-backend

jobs:
    build-and-deploy:
        name: Build and Deploy
        runs-on: ubuntu-latest

        # Required permissions for GHCR push and Azure deployment
        permissions:
            contents: read
            packages: write

        steps:
            # =========================================================================
            # Log trigger information
            # =========================================================================

            - name: Log trigger source
              run: |
                  echo "=========================================="
                  echo "Deployment Triggered"
                  echo "=========================================="
                  echo "Event: ${{ github.event_name }}"
                  if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
                    echo "Service: ${{ github.event.client_payload.service }}"
                    echo "Service SHA: ${{ github.event.client_payload.sha }}"
                  fi
                  echo "Run ID: ${{ github.run_id }}"
                  echo "=========================================="

            # =========================================================================
            # Checkout all required repositories
            # =========================================================================

            - name: Checkout infra repository
              uses: actions/checkout@v4
              with:
                  path: infra

            - name: Checkout socket-hub repository
              uses: actions/checkout@v4
              with:
                  repository: Luxia-AI/socket-hub
                  path: socket-hub
                  # Use dev branch for latest features
                  ref: dev

            - name: Checkout dispatcher repository
              uses: actions/checkout@v4
              with:
                  repository: Luxia-AI/dispatcher
                  path: dispatcher
                  ref: dev

            - name: Checkout worker repository
              uses: actions/checkout@v4
              with:
                  repository: Luxia-AI/worker
                  path: worker
                  ref: feature/develop-evidence-validation-&-admin-approval

            - name: Checkout shared repository
              uses: actions/checkout@v4
              with:
                  repository: Luxia-AI/shared
                  path: shared
                  ref: main

            # =========================================================================
            # Generate unique image tag
            # =========================================================================

            - name: Generate image tag
              id: tag
              run: |
                  # Use run_id for uniqueness (different for each workflow run)
                  TAG="run-${{ github.run_id }}"
                  echo "tag=$TAG" >> $GITHUB_OUTPUT
                  echo "Generated tag: $TAG"

            # =========================================================================
            # Build and push Docker image
            # =========================================================================

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Log in to GitHub Container Registry
              uses: docker/login-action@v3
              with:
                  registry: ${{ env.REGISTRY }}
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Build and push Docker image
              uses: docker/build-push-action@v5
              with:
                  context: .
                  file: infra/azure/Dockerfile
                  push: true
                  tags: |
                      ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.tag.outputs.tag }}
                      ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
                  cache-from: type=gha
                  cache-to: type=gha,mode=max

            # =========================================================================
            # Deploy to Azure App Service
            # =========================================================================

            - name: Deploy to Azure Web App
              uses: azure/webapps-deploy@v3
              with:
                  app-name: ${{ env.AZURE_WEBAPP_NAME }}
                  images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.tag.outputs.tag }}
                  publish-profile: ${{ secrets.AZURE_PUBLISH_PROFILE }}

            # =========================================================================
            # Post-deployment verification
            # =========================================================================

            - name: Output deployment info
              run: |
                  echo "=========================================="
                  echo "Deployment Complete"
                  echo "=========================================="
                  echo "Image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.tag.outputs.tag }}"
                  echo "Image (latest): ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
                  echo "App Service: ${{ env.AZURE_WEBAPP_NAME }}"
                  echo "Workflow SHA: ${{ github.sha }}"
                  if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
                    echo "Triggered by: ${{ github.event.client_payload.service }}"
                  fi
                  echo "=========================================="
